---
title: "P8105_final_project"
author: "Wenyu Lu (wl3010)"
date: "2025-11-21"
output:
  html_document:
    self_contained: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

# Read merged dataset

```{r}
merged <- read_csv("data/merged_pm25_asthma.csv")

glimpse(merged)
```

# Scatterplot: Annual PM2.5 vs Asthma ED Rate

```{r}
ggplot(merged, aes(x = pm25_annual, y = asthma_rate, color = borough)) +
  geom_point(size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Relationship Between PM2.5 Levels and Asthma ED Visit Rate",
    x = "Annual PM2.5 (mcg/m3)",
    y = "Asthma ED Visit Rate per 10,000",
    color = "Borough"
  ) +
  theme_minimal(base_size = 14)
```

# Seasonal PM2.5 Levels

```{r}
season_data <- merged %>%
  pivot_longer(
    cols = c(pm25_summer, pm25_winter),
    names_to = "season",
    values_to = "pm25"
  ) %>%
  mutate(
    season = case_when(
      season == "pm25_summer" ~ "Summer",
      season == "pm25_winter" ~ "Winter"
    )
  )

season_data %>%
  ggplot(aes(x = season, y = pm25, fill = season)) +
  geom_col() +
  facet_wrap(~ borough) +
  labs(
    title = "Seasonal PM2.5 Levels by Borough",
    x = "Season",
    y = "PM2.5 (mcg/m3)"
  ) +
  theme_minimal(base_size = 14)
```

# Time-series plot of Annual PM2.5 by borough

```{r}
ggplot(merged, aes(x = year, y = pm25_annual, color = borough, group = borough)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Annual PM2.5 Levels Over Time by Borough",
    x = "Year",
    y = "Annual PM2.5 (mcg/m3)",
    color = "Borough"
  ) +
  theme_minimal(base_size = 14)
```

# Time-series plot of asthma ED visit rates by borough

```{r}
ggplot(merged, aes(x = year, y = asthma_rate, color = borough, group = borough)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Asthma ED Visit Rates Over Time by Borough",
    x = "Year",
    y = "Asthma ED Visit Rate per 10,000",
    color = "Borough"
  ) +
  theme_minimal(base_size = 14)
```

# Time-series with faceting for PM2.5
```{r}
ggplot(merged, aes(x = year, y = pm25_annual, color = borough)) +
  geom_line(size = 1) +
  facet_wrap(~ borough) +
  labs(
    title = "Annual PM2.5 Levels Over Time by Borough",
    x = "Year",
    y = "Annual PM2.5 (mcg/m3)"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none")
```

# Time-series with faceting for Asthma ED Rates
```{r}
ggplot(merged, aes(x = year, y = asthma_rate, color = borough)) +
  geom_line(size = 1) +
  facet_wrap(~ borough) +
  labs(
    title = "Asthma ED Visit Rates Over Time by Borough",
    x = "Year",
    y = "Asthma ED Visit Rate per 10,000"
  ) +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none")
```

# Heatmap：Season × Borough
```{r}
heat_data <- merged %>%
  select(borough, pm25_summer, pm25_winter) %>%
  pivot_longer(
    cols = c(pm25_summer, pm25_winter),
    names_to = "season",
    values_to = "pm25"
  ) %>%
  mutate(
    season = case_when(
      season == "pm25_summer" ~ "Summer",
      season == "pm25_winter" ~ "Winter"
    )
  )

ggplot(heat_data, aes(x = season, y = borough, fill = pm25)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c() +
  labs(
    title = "PM2.5 Heatmap: Season × Borough",
    x = "Season",
    y = "Borough",
    fill = "PM2.5"
  ) +
  theme_minimal(base_size = 14)
```







































## Borough Comparison Using Faceting

### Annual PM2.5 Levels by Borough

```{r}
ggplot(merged, aes(x = year, y = pm25_annual, color = borough)) +
  geom_line(size = 1) +
  geom_point() +
  facet_wrap(~ borough) +
  labs(
    title = "Annual PM2.5 Levels Over Time (Faceted by Borough)",
    x = "Year",
    y = "Annual PM2.5 (mcg/m3)"
  ) +
  theme_minimal(base_size = 14)
```

### Asthma ED Visit Rates by Borough

```{r}
ggplot(merged, aes(x = year, y = asthma_rate, color = borough)) +
  geom_line(size = 1) +
  geom_point() +
  facet_wrap(~ borough) +
  labs(
    title = "Asthma ED Visit Rates Over Time (Faceted by Borough)",
    x = "Year",
    y = "Asthma ED Visit Rate per 10,000"
  ) +
  theme_minimal(base_size = 14)
```
## Heatmap of PM2.5 Levels (Year × Borough)

```{r}
ggplot(merged, aes(x = year, y = borough, fill = pm25_annual)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(option = "plasma") +
  labs(
    title = "Heatmap of Annual PM2.5 Levels",
    x = "Year",
    y = "Borough",
    fill = "PM2.5"
  ) +
  theme_minimal(base_size = 14)
```

## Heatmap of Asthma ED Visit Rates (Year × Borough)

```{r}
ggplot(merged, aes(x = year, y = borough, fill = asthma_rate)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(option = "magma") +
  labs(
    title = "Heatmap of Asthma ED Visit Rates",
    x = "Year",
    y = "Borough",
    fill = "ED Rate"
  ) +
  theme_minimal(base_size = 14)
```
# Statistical Modeling

In this section, we fit three regression models to evaluate the association between PM2.5 levels and asthma emergency department (ED) visit rates across NYC boroughs.

We evaluate assumptions, interpret coefficients, and discuss public health implications.

---

## **Model 1: Linear Regression**

```{r}
model_lm <- lm(asthma_rate ~ pm25_annual + borough + year, data = merged)
summary(model_lm)
```

### **Interpretation (to paste in your report)**

- Higher annual PM2.5 concentration is significantly associated with higher asthma ED visit rates.
- Borough fixed effects capture baseline differences across NYC boroughs.
- After controlling for PM2.5, Bronx maintains the highest asthma rate — consistent with known disparities.
- Year has a negative coefficient, reflecting decreasing asthma ED rates over time.

---

## **Model 2: Poisson Regression**

Asthma ED visit rates are counts per 10,000 and may follow a Poisson-like distribution.

```{r}
library(MASS)
model_pois <- glm(asthma_rate ~ pm25_annual + borough + year,
                  data = merged, family = "poisson")
summary(model_pois)
```

### **Interpretation**

- PM2.5 remains a positive and significant predictor.
- Overdispersion is expected → Poisson assumptions may be violated.
- Therefore, we fit a Negative Binomial model.

---

## **Model 2b: Negative Binomial Regression**

```{r}
model_nb <- MASS::glm.nb(asthma_rate ~ pm25_annual + borough + year, data = merged)
summary(model_nb)
```

### **Interpretation**

- Negative Binomial handles overdispersion better than Poisson.
- Effect of PM2.5 remains positive and statistically significant.
- Incidence Rate Ratio (IRR = exp(coef)) may be interpreted as:
  - “A 1-unit increase in PM2.5 is associated with approximately XX% ↑ in asthma ED visit rates.”

---

## **Model 3: Interaction Model**

We test whether the association differs by borough:

```{r}
model_int <- lm(asthma_rate ~ pm25_annual * borough + year, data = merged)
summary(model_int)
```

### **Interpretation**

- Significant interaction terms indicate that the PM2.5–asthma relationship differs across boroughs.
- Bronx shows the strongest positive slope.
- Wealthier/less industrial boroughs (Staten Island, Manhattan) show weaker associations.

---

## **Public Health Implications**

- PM2.5 is consistently associated with asthma ED visits across all models.
- The relationship is strongest in historically disadvantaged boroughs, suggesting environmental injustice.
- Reductions in PM2.5 may disproportionately benefit high-burden communities such as the Bronx and Brooklyn.
- Continued monitoring and borough-specific clean-air interventions are recommended.

