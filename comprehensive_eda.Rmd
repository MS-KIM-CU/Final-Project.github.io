---
title: "Exploratory Data Analysis"
subtitle: "Air Pollution and Asthma in NYC (2009-2023)"
author: "Minseo Kim, Wenyu Lu, Jiaqi Zhu"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: cosmo
    code_folding: hide
    df_print: paged
---

<style>
.main-container {
  max-width: 1400px;
  margin: auto;
  padding: 20px;
}

body {
  color: #2d3748;
  font-size: 16px;
  line-height: 1.6;
}

/* Only style section h1 headers (exclude document title) */
h1:not(.title) {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white !important;
  padding: 20px 25px;
  border-radius: 12px;
  margin-top: 35px;
  margin-bottom: 20px;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
  font-weight: 600;
  font-size: 1.8em;
}

h1.title {
  color: #1a202c;
  font-weight: 700;
  margin-bottom: 10px;
}

h2, h3, h4, h5, h6 {
  color: #1a202c;
  font-weight: 600;
}

/* Author styling */
h4.author {
  color: #64748b;
  font-size: 1.1em;
  margin-top: 5px;
  margin-bottom: 30px;
  font-style: italic;
  font-weight: 400;
}

.key-finding {
  background: linear-gradient(to right, #eff6ff, #dbeafe);
  border-left: 5px solid #2563eb;
  padding: 18px;
  margin: 20px 0;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
}

.key-finding strong {
  color: #1e40af;
  font-weight: 700;
}

.stat-box {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 25px;
  border-radius: 12px;
  text-align: center;
  margin: 15px 5px;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  transition: transform 0.2s;
}

.stat-box:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.stat-value {
  font-size: 2.5em;
  font-weight: bold;
  margin: 15px 0;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

.stat-label {
  font-size: 1.05em;
  opacity: 0.95;
  line-height: 1.4;
}

.tabset-pills > li > a {
  border-radius: 20px;
  padding: 10px 24px;
  margin: 5px;
  font-weight: 600;
  transition: all 0.3s;
}

.tabset-pills > li.active > a {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.tabset-pills > li > a:hover {
  background-color: #e0e7ff;
}

.plotly {
  width: 100% !important;
  max-width: 100%;
}

.plotly .main-svg {
  max-width: 100%;
}

table {
  width: 100%;
  border-collapse: collapse;
}

img, 
.plotly,
.html-widget {
  max-width: 100%;
  height: auto;
}

.row {
  display: flex;
  flex-wrap: wrap;
  margin: -10px;
}

.col-md-3 {
  flex: 0 0 25%;
  max-width: 25%;
  padding: 10px;
}

@media (max-width: 992px) {
  .col-md-3 {
    flex: 0 0 50%;
    max-width: 50%;
  }
}

@media (max-width: 576px) {
  .col-md-3 {
    flex: 0 0 100%;
    max-width: 100%;
  }
}

.footer-box {
  background-color: #f8fafc;
  border: 1px solid #e2e8f0;
  padding: 25px;
  border-radius: 12px;
  margin-top: 40px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 3.5,
  out.width = "100%",
  dpi = 300
)

library(tidyverse)
library(plotly)
library(viridis)
library(ggthemes)
library(scales)
library(patchwork)
library(knitr)
library(DT)
```

```{r load-data, include=FALSE}
pm25_asthma <- read_csv("data/merged_pm25_asthma.csv")

pm25_asthma_clean <- pm25_asthma %>%
  mutate(
    borough = factor(borough, 
                     levels = c("Manhattan", "Bronx", "Brooklyn", 
                                "Queens", "Staten Island"))
  ) %>%
  arrange(year, borough)

df_long <- pm25_asthma_clean %>%
  pivot_longer(
    cols = c(pm25_annual, pm25_summer, pm25_winter),
    names_to = "pm25_type",
    values_to = "pm25_value"
  ) %>%
  mutate(
    pm25_type = case_when(
      pm25_type == "pm25_annual" ~ "Annual",
      pm25_type == "pm25_summer" ~ "Summer",
      pm25_type == "pm25_winter" ~ "Winter"
    ),
    pm25_type = factor(pm25_type, levels = c("Annual", "Summer", "Winter"))
  )

pm25_asthma_clean <- pm25_asthma_clean %>%
  mutate(pm25_diff = pm25_winter - pm25_summer)
```

---

# Overview

This comprehensive exploratory data analysis examines the relationship between air pollution (PM2.5) and asthma emergency department visits across NYC's five boroughs from 2009 to 2023.

## Dataset Summary

```{r data-summary}
summary_table <- tibble(
  Metric = c("Time Period", "Boroughs", "Total Observations", 
             "PM2.5 Range (μg/m³)", "Asthma Rate Range (per 10,000)"),
  Value = c(
    "2009-2023 (14 years)",
    "Manhattan, Bronx, Brooklyn, Queens, Staten Island",
    nrow(pm25_asthma_clean),
    sprintf("%.1f - %.1f", min(pm25_asthma_clean$pm25_annual, na.rm = TRUE), 
            max(pm25_asthma_clean$pm25_annual, na.rm = TRUE)),
    sprintf("%.1f - %.1f", min(pm25_asthma_clean$asthma_rate, na.rm = TRUE), 
            max(pm25_asthma_clean$asthma_rate, na.rm = TRUE))
  )
)

kable(summary_table, col.names = c("", ""), align = c("l", "l"))
```

## Key Statistics by Borough

```{r borough-stats}
borough_summary <- pm25_asthma_clean %>%
  group_by(borough) %>%
  summarise(
    `Mean PM2.5` = round(mean(pm25_annual, na.rm = TRUE), 1),
    `Mean Asthma Rate` = round(mean(asthma_rate, na.rm = TRUE), 1),
    `2023 PM2.5` = round(pm25_annual[year == 2023], 1),
    `2023 Asthma` = round(asthma_rate[year == 2023], 1),
    `PM2.5 Change` = round(pm25_annual[year == 2023] - pm25_annual[year == 2009], 1),
    `Asthma Change` = round(asthma_rate[year == 2023] - asthma_rate[year == 2009], 1)
  ) %>%
  arrange(desc(`Mean Asthma Rate`))

datatable(borough_summary, 
          options = list(pageLength = 5, dom = 't'),
          rownames = FALSE) %>%
  formatStyle('Mean Asthma Rate',
              background = styleColorBar(borough_summary$`Mean Asthma Rate`, '#fecaca'),
              backgroundSize = '100% 90%',
              backgroundRepeat = 'no-repeat',
              backgroundPosition = 'center')
```

---

# Time Series Analysis

## PM2.5 Trends Over Time

```{r pm25-timeseries}
p1 <- pm25_asthma_clean %>%
  plot_ly(x = ~year, y = ~pm25_annual, color = ~borough,
          type = 'scatter', mode = 'lines+markers',
          colors = viridis(5),
          hovertemplate = paste(
            '<b>%{fullData.name}</b><br>',
            'Year: %{x}<br>',
            'PM2.5: %{y:.2f} μg/m³<br>',
            '<extra></extra>'
          )) %>%
  layout(
    title = list(text = "<b>Annual PM2.5 Concentrations by Borough (2009-2023)</b>", font = list(size = 16)),
    xaxis = list(title = "Year", titlefont = list(size = 13), tickfont = list(size = 11)),
    yaxis = list(title = "PM2.5 (μg/m³)", titlefont = list(size = 13), tickfont = list(size = 11)),
    hovermode = 'closest',
    legend = list(title = list(text = '<b>Borough</b>'), x = 1.02, y = 1, font = list(size = 10)),
    margin = list(l = 60, r = 100, t = 60, b = 50),
    autosize = TRUE
  )

p1
```

<div class="key-finding">
**Key Finding:** All five boroughs show consistent downward trends in PM2.5 concentrations, with Manhattan experiencing the steepest decline from 12.6 to 7.3 μg/m³ (42% reduction).
</div>

## Asthma ED Visit Trends

```{r asthma-timeseries}
p2 <- pm25_asthma_clean %>%
  plot_ly(x = ~year, y = ~asthma_rate, color = ~borough,
          type = 'scatter', mode = 'lines+markers',
          colors = viridis(5, option = "plasma"),
          hovertemplate = paste(
            '<b>%{fullData.name}</b><br>',
            'Year: %{x}<br>',
            'ED Visit Rate: %{y:.1f} per 10,000<br>',
            '<extra></extra>'
          )) %>%
  layout(
    title = list(text = "<b>Asthma Emergency Department Visit Rates by Borough (2009-2023)</b>", font = list(size = 16)),
    xaxis = list(title = "Year", titlefont = list(size = 13), tickfont = list(size = 11)),
    yaxis = list(title = "ED Visit Rate (per 10,000)", titlefont = list(size = 13), tickfont = list(size = 11)),
    hovermode = 'closest',
    legend = list(title = list(text = '<b>Borough</b>'), x = 1.02, y = 1, font = list(size = 10)),
    margin = list(l = 60, r = 100, t = 60, b = 50),
    autosize = TRUE
  )

p2
```

<div class="key-finding">
**Key Finding:** The Bronx consistently shows asthma ED rates 2-4 times higher than other boroughs throughout the study period, highlighting persistent health disparities.
</div>

## Borough Comparisons {.tabset .tabset-pills}

### Manhattan

```{r manhattan-dual, fig.height=3}
manhattan_data <- pm25_asthma_clean %>% filter(borough == "Manhattan")

plot_ly(manhattan_data) %>%
  add_trace(x = ~year, y = ~pm25_annual, type = 'scatter', mode = 'lines+markers',
            name = 'PM2.5', yaxis = 'y',
            line = list(color = '#f59e0b', width = 2.5), marker = list(size = 7)) %>%
  add_trace(x = ~year, y = ~asthma_rate, type = 'scatter', mode = 'lines+markers',
            name = 'Asthma Rate', yaxis = 'y2',
            line = list(color = '#dc2626', width = 2.5), marker = list(size = 7)) %>%
  layout(
    title = list(text = "<b>Manhattan: PM2.5 vs Asthma ED Visits</b>", font = list(size = 15)),
    xaxis = list(title = "Year", titlefont = list(size = 12)),
    yaxis = list(title = "PM2.5 (μg/m³)", titlefont = list(size = 12, color = '#f59e0b'), tickfont = list(color = '#f59e0b')),
    yaxis2 = list(title = "Asthma Rate (per 10,000)", titlefont = list(size = 12, color = '#dc2626'), 
                  tickfont = list(color = '#dc2626'), overlaying = 'y', side = 'right'),
    margin = list(l = 60, r = 60, t = 50, b = 40),
    hovermode = 'x unified'
  )
```

### Bronx

```{r bronx-dual, fig.height=3}
bronx_data <- pm25_asthma_clean %>% filter(borough == "Bronx")

plot_ly(bronx_data) %>%
  add_trace(x = ~year, y = ~pm25_annual, type = 'scatter', mode = 'lines+markers',
            name = 'PM2.5', yaxis = 'y',
            line = list(color = '#f59e0b', width = 2.5), marker = list(size = 7)) %>%
  add_trace(x = ~year, y = ~asthma_rate, type = 'scatter', mode = 'lines+markers',
            name = 'Asthma Rate', yaxis = 'y2',
            line = list(color = '#dc2626', width = 2.5), marker = list(size = 7)) %>%
  layout(
    title = list(text = "<b>Bronx: PM2.5 vs Asthma ED Visits</b>", font = list(size = 15)),
    xaxis = list(title = "Year", titlefont = list(size = 12)),
    yaxis = list(title = "PM2.5 (μg/m³)", titlefont = list(size = 12, color = '#f59e0b'), tickfont = list(color = '#f59e0b')),
    yaxis2 = list(title = "Asthma Rate (per 10,000)", titlefont = list(size = 12, color = '#dc2626'), 
                  tickfont = list(color = '#dc2626'), overlaying = 'y', side = 'right'),
    margin = list(l = 60, r = 60, t = 50, b = 40),
    hovermode = 'x unified'
  )
```

### Brooklyn

```{r brooklyn-dual, fig.height=3}
brooklyn_data <- pm25_asthma_clean %>% filter(borough == "Brooklyn")

plot_ly(brooklyn_data) %>%
  add_trace(x = ~year, y = ~pm25_annual, type = 'scatter', mode = 'lines+markers',
            name = 'PM2.5', yaxis = 'y',
            line = list(color = '#f59e0b', width = 2.5), marker = list(size = 7)) %>%
  add_trace(x = ~year, y = ~asthma_rate, type = 'scatter', mode = 'lines+markers',
            name = 'Asthma Rate', yaxis = 'y2',
            line = list(color = '#dc2626', width = 2.5), marker = list(size = 7)) %>%
  layout(
    title = list(text = "<b>Brooklyn: PM2.5 vs Asthma ED Visits</b>", font = list(size = 15)),
    xaxis = list(title = "Year", titlefont = list(size = 12)),
    yaxis = list(title = "PM2.5 (μg/m³)", titlefont = list(size = 12, color = '#f59e0b'), tickfont = list(color = '#f59e0b')),
    yaxis2 = list(title = "Asthma Rate (per 10,000)", titlefont = list(size = 12, color = '#dc2626'), 
                  tickfont = list(color = '#dc2626'), overlaying = 'y', side = 'right'),
    margin = list(l = 60, r = 60, t = 50, b = 40),
    hovermode = 'x unified'
  )
```

### Queens

```{r queens-dual, fig.height=3}
queens_data <- pm25_asthma_clean %>% filter(borough == "Queens")

plot_ly(queens_data) %>%
  add_trace(x = ~year, y = ~pm25_annual, type = 'scatter', mode = 'lines+markers',
            name = 'PM2.5', yaxis = 'y',
            line = list(color = '#f59e0b', width = 2.5), marker = list(size = 7)) %>%
  add_trace(x = ~year, y = ~asthma_rate, type = 'scatter', mode = 'lines+markers',
            name = 'Asthma Rate', yaxis = 'y2',
            line = list(color = '#dc2626', width = 2.5), marker = list(size = 7)) %>%
  layout(
    title = list(text = "<b>Queens: PM2.5 vs Asthma ED Visits</b>", font = list(size = 15)),
    xaxis = list(title = "Year", titlefont = list(size = 12)),
    yaxis = list(title = "PM2.5 (μg/m³)", titlefont = list(size = 12, color = '#f59e0b'), tickfont = list(color = '#f59e0b')),
    yaxis2 = list(title = "Asthma Rate (per 10,000)", titlefont = list(size = 12, color = '#dc2626'), 
                  tickfont = list(color = '#dc2626'), overlaying = 'y', side = 'right'),
    margin = list(l = 60, r = 60, t = 50, b = 40),
    hovermode = 'x unified'
  )
```

### Staten Island

```{r staten-dual, fig.height=3}
staten_data <- pm25_asthma_clean %>% filter(borough == "Staten Island")

plot_ly(staten_data) %>%
  add_trace(x = ~year, y = ~pm25_annual, type = 'scatter', mode = 'lines+markers',
            name = 'PM2.5', yaxis = 'y',
            line = list(color = '#f59e0b', width = 2.5), marker = list(size = 7)) %>%
  add_trace(x = ~year, y = ~asthma_rate, type = 'scatter', mode = 'lines+markers',
            name = 'Asthma Rate', yaxis = 'y2',
            line = list(color = '#dc2626', width = 2.5), marker = list(size = 7)) %>%
  layout(
    title = list(text = "<b>Staten Island: PM2.5 vs Asthma ED Visits</b>", font = list(size = 15)),
    xaxis = list(title = "Year", titlefont = list(size = 12)),
    yaxis = list(title = "PM2.5 (μg/m³)", titlefont = list(size = 12, color = '#f59e0b'), tickfont = list(color = '#f59e0b')),
    yaxis2 = list(title = "Asthma Rate (per 10,000)", titlefont = list(size = 12, color = '#dc2626'), 
                  tickfont = list(color = '#dc2626'), overlaying = 'y', side = 'right'),
    margin = list(l = 60, r = 60, t = 50, b = 40),
    hovermode = 'x unified'
  )
```

---

# Association Analysis

## PM2.5 vs Asthma Rate Correlation

```{r correlation-scatter}
cor_by_borough <- pm25_asthma_clean %>%
  group_by(borough) %>%
  summarise(correlation = cor(pm25_annual, asthma_rate, use = "complete.obs"), .groups = 'drop')

plot_ly(pm25_asthma_clean, x = ~pm25_annual, y = ~asthma_rate, 
        color = ~borough, colors = viridis(5),
        type = 'scatter', mode = 'markers',
        marker = list(size = 8, opacity = 0.7),
        text = ~paste('Year:', year, '<br>Borough:', borough,
                     '<br>PM2.5:', round(pm25_annual, 1),
                     '<br>Asthma Rate:', round(asthma_rate, 1)),
        hoverinfo = 'text') %>%
  layout(
    title = list(text = "<b>PM2.5 vs Asthma ED Visit Rates</b>", font = list(size = 16)),
    xaxis = list(title = "PM2.5 (μg/m³)", titlefont = list(size = 13)),
    yaxis = list(title = "Asthma ED Visit Rate (per 10,000)", titlefont = list(size = 13)),
    legend = list(title = list(text = '<b>Borough</b>'), font = list(size = 10)),
    margin = list(l = 60, r = 80, t = 60, b = 50),
    autosize = TRUE
  )
```

### Correlation Summary

```{r correlation-table}
cor_table <- pm25_asthma_clean %>%
  group_by(borough) %>%
  summarise(
    `Correlation (r)` = round(cor(pm25_annual, asthma_rate, use = "complete.obs"), 3),
    `Mean PM2.5` = round(mean(pm25_annual, na.rm = TRUE), 1),
    `Mean Asthma Rate` = round(mean(asthma_rate, na.rm = TRUE), 1),
    .groups = 'drop'
  ) %>%
  arrange(desc(`Correlation (r)`))

datatable(cor_table, options = list(pageLength = 5, dom = 't'), rownames = FALSE)
```

<div class="key-finding">
**Key Finding:** Strong positive correlations (r > 0.7) between PM2.5 and asthma rates across all boroughs, with Brooklyn showing the strongest association (r = 0.82).
</div>

---

# Borough Comparison

## Geographic Patterns {.tabset .tabset-pills}

### PM2.5 Trends

```{r borough-pm25-facet, fig.height=4.5}
ggplot(pm25_asthma_clean, aes(x = year, y = pm25_annual, color = borough)) +
  geom_line(size = 1.2) +
  geom_point(size = 2.5) +
  facet_wrap(~ borough, ncol = 2, scales = "free_y") +
  scale_color_viridis_d() +
  labs(title = "PM2.5 Concentration Trends by Borough (2009-2023)",
       x = "Year", y = "PM2.5 (μg/m³)") +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    strip.text = element_text(face = "bold", size = 11),
    strip.background = element_rect(fill = "gray90", color = NA),
    legend.position = "none",
    panel.grid.minor = element_blank()
  )
```

### Asthma Trends

```{r borough-asthma-facet, fig.height=4.5}
ggplot(pm25_asthma_clean, aes(x = year, y = asthma_rate, color = borough)) +
  geom_line(size = 1.2) +
  geom_point(size = 2.5) +
  facet_wrap(~ borough, ncol = 2, scales = "free_y") +
  scale_color_viridis_d(option = "plasma") +
  labs(title = "Asthma ED Visit Rate Trends by Borough (2009-2023)",
       x = "Year", y = "Asthma ED Visit Rate (per 10,000)") +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    strip.text = element_text(face = "bold", size = 11),
    strip.background = element_rect(fill = "gray90", color = NA),
    legend.position = "none",
    panel.grid.minor = element_blank()
  )
```

### Association by Borough

```{r borough-scatter-facet, fig.height=4.5}
ggplot(pm25_asthma_clean, aes(x = pm25_annual, y = asthma_rate)) +
  geom_point(aes(color = borough), size = 2.5, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE, color = "#2563eb", size = 0.8) +
  facet_wrap(~ borough, ncol = 2, scales = "free") +
  scale_color_viridis_d() +
  labs(title = "PM2.5 vs Asthma Rate Relationship by Borough",
       x = "PM2.5 (μg/m³)", y = "Asthma ED Visit Rate (per 10,000)") +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    strip.text = element_text(face = "bold", size = 11),
    strip.background = element_rect(fill = "gray90", color = NA),
    legend.position = "none",
    panel.grid.minor = element_blank()
  )
```

### 2023 Comparison

```{r borough-comparison, fig.height=3.5, fig.width=12}
data_2023 <- pm25_asthma_clean %>% filter(year == 2023)

p_pm25 <- ggplot(data_2023, aes(x = reorder(borough, -pm25_annual), y = pm25_annual, fill = borough)) +
  geom_col(alpha = 0.8) +
  geom_text(aes(label = round(pm25_annual, 1)), vjust = -0.5, size = 4, fontface = "bold") +
  scale_fill_viridis_d() +
  labs(title = "PM2.5 Levels (2023)", x = NULL, y = "PM2.5 (μg/m³)") +
  theme_minimal(base_size = 11) +
  theme(plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, max(data_2023$pm25_annual) * 1.15)

p_asthma <- ggplot(data_2023, aes(x = reorder(borough, -asthma_rate), y = asthma_rate, fill = borough)) +
  geom_col(alpha = 0.8) +
  geom_text(aes(label = round(asthma_rate, 1)), vjust = -0.5, size = 4, fontface = "bold") +
  scale_fill_viridis_d(option = "plasma") +
  labs(title = "Asthma ED Rates (2023)", x = NULL, y = "Asthma Rate (per 10,000)") +
  theme_minimal(base_size = 11) +
  theme(plot.title = element_text(face = "bold", size = 12, hjust = 0.5),
        legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(0, max(data_2023$asthma_rate) * 1.15)

p_pm25 + p_asthma
```

---

# Seasonal Patterns

## Summer vs Winter

```{r seasonal-boxplot, fig.height=3.5}
seasonal_long <- pm25_asthma_clean %>%
  select(borough, year, pm25_summer, pm25_winter) %>%
  pivot_longer(cols = c(pm25_summer, pm25_winter), names_to = "season", values_to = "pm25") %>%
  mutate(season = ifelse(season == "pm25_summer", "Summer", "Winter"))

ggplot(seasonal_long, aes(x = borough, y = pm25, fill = season)) +
  geom_boxplot(alpha = 0.8, outlier.shape = 21, outlier.size = 1.5) +
  scale_fill_manual(values = c("Summer" = "#fbbf24", "Winter" = "#60a5fa")) +
  labs(title = "Seasonal PM2.5 Distribution by Borough (2009-2023)",
       x = "Borough", y = "PM2.5 (μg/m³)", fill = "Season") +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.minor = element_blank()
  )
```

## Seasonal Trends Over Time

```{r seasonal-trends, fig.height=4.5}
ggplot(df_long, aes(x = year, y = pm25_value, color = pm25_type, group = pm25_type)) +
  geom_line(size = 1) +
  geom_point(size = 1.5) +
  facet_wrap(~ borough, ncol = 2, scales = "free_y") +
  scale_color_manual(values = c("Annual" = "#667eea", "Summer" = "#fbbf24", "Winter" = "#60a5fa")) +
  labs(title = "Seasonal PM2.5 Trends by Borough (2009-2023)",
       x = "Year", y = "PM2.5 (μg/m³)", color = "Measurement") +
  theme_minimal(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    strip.text = element_text(face = "bold", size = 10),
    strip.background = element_rect(fill = "gray90", color = NA),
    legend.position = "top",
    panel.grid.minor = element_blank()
  )
```

<div class="key-finding">
**Key Finding:** Historical winter peaks in PM2.5 have diminished over time, with summer and winter levels now converging in most boroughs.
</div>

---

# Heatmap Analysis

## Interactive Heatmaps {.tabset .tabset-pills}

### Annual PM2.5

```{r heatmap-pm25, fig.height=3.5}
heatmap_data_pm25 <- pm25_asthma_clean %>%
  select(year, borough, pm25_annual) %>%
  pivot_wider(names_from = borough, values_from = pm25_annual) %>%
  column_to_rownames("year")

plot_ly(
  x = colnames(heatmap_data_pm25),
  y = rownames(heatmap_data_pm25),
  z = as.matrix(heatmap_data_pm25),
  type = "heatmap",
  colors = colorRamp(c("#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026", "#800026")),
  hovertemplate = 'Borough: %{x}<br>Year: %{y}<br>PM2.5: %{z:.1f} μg/m³<extra></extra>'
) %>%
  layout(
    title = list(text = "<b>Annual PM2.5 Concentrations (2009-2023)</b>", font = list(size = 15)),
    xaxis = list(title = "Borough", titlefont = list(size = 12)),
    yaxis = list(title = "Year", titlefont = list(size = 12)),
    margin = list(l = 60, r = 80, t = 60, b = 60)
  )
```

### Asthma Rate

```{r heatmap-asthma, fig.height=3.5}
heatmap_data_asthma <- pm25_asthma_clean %>%
  select(year, borough, asthma_rate) %>%
  pivot_wider(names_from = borough, values_from = asthma_rate) %>%
  column_to_rownames("year")

plot_ly(
  x = colnames(heatmap_data_asthma),
  y = rownames(heatmap_data_asthma),
  z = as.matrix(heatmap_data_asthma),
  type = "heatmap",
  colors = colorRamp(c("#fff5f0", "#fee0d2", "#fcbba1", "#fc9272", "#fb6a4a", "#ef3b2c", "#cb181d", "#a50f15", "#67000d")),
  hovertemplate = 'Borough: %{x}<br>Year: %{y}<br>Asthma Rate: %{z:.1f} per 10,000<extra></extra>'
) %>%
  layout(
    title = list(text = "<b>Asthma ED Visit Rates (2009-2023)</b>", font = list(size = 15)),
    xaxis = list(title = "Borough", titlefont = list(size = 12)),
    yaxis = list(title = "Year", titlefont = list(size = 12)),
    margin = list(l = 60, r = 80, t = 60, b = 60)
  )
```

### Summer PM2.5

```{r heatmap-summer, fig.height=3.5}
heatmap_data_summer <- pm25_asthma_clean %>%
  select(year, borough, pm25_summer) %>%
  pivot_wider(names_from = borough, values_from = pm25_summer) %>%
  column_to_rownames("year")

plot_ly(
  x = colnames(heatmap_data_summer),
  y = rownames(heatmap_data_summer),
  z = as.matrix(heatmap_data_summer),
  type = "heatmap",
  colors = colorRamp(c("#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c")),
  hovertemplate = 'Borough: %{x}<br>Year: %{y}<br>Summer PM2.5: %{z:.1f} μg/m³<extra></extra>'
) %>%
  layout(
    title = list(text = "<b>Summer PM2.5 Concentrations (2009-2023)</b>", font = list(size = 15)),
    xaxis = list(title = "Borough", titlefont = list(size = 12)),
    yaxis = list(title = "Year", titlefont = list(size = 12)),
    margin = list(l = 60, r = 80, t = 60, b = 60)
  )
```

### Winter PM2.5

```{r heatmap-winter, fig.height=3.5}
heatmap_data_winter <- pm25_asthma_clean %>%
  select(year, borough, pm25_winter) %>%
  pivot_wider(names_from = borough, values_from = pm25_winter) %>%
  column_to_rownames("year")

plot_ly(
  x = colnames(heatmap_data_winter),
  y = rownames(heatmap_data_winter),
  z = as.matrix(heatmap_data_winter),
  type = "heatmap",
  colors = colorRamp(c("#f7fbff", "#deebf7", "#c6dbef", "#9ecae1", "#6baed6", "#4292c6", "#2171b5", "#08519c", "#08306b")),
  hovertemplate = 'Borough: %{x}<br>Year: %{y}<br>Winter PM2.5: %{z:.1f} μg/m³<extra></extra>'
) %>%
  layout(
    title = list(text = "<b>Winter PM2.5 Concentrations (2009-2023)</b>", font = list(size = 15)),
    xaxis = list(title = "Borough", titlefont = list(size = 12)),
    yaxis = list(title = "Year", titlefont = list(size = 12)),
    margin = list(l = 60, r = 80, t = 60, b = 60)
  )
```

### Seasonal Difference

```{r heatmap-difference, fig.height=3.5}
heatmap_data_diff <- pm25_asthma_clean %>%
  select(year, borough, pm25_diff) %>%
  pivot_wider(names_from = borough, values_from = pm25_diff) %>%
  column_to_rownames("year")

plot_ly(
  x = colnames(heatmap_data_diff),
  y = rownames(heatmap_data_diff),
  z = as.matrix(heatmap_data_diff),
  type = "heatmap",
  colors = colorRamp(c("#0571b0", "#92c5de", "#f7f7f7", "#f4a582", "#ca0020")),
  hovertemplate = 'Borough: %{x}<br>Year: %{y}<br>Difference: %{z:.1f} μg/m³<extra></extra>'
) %>%
  layout(
    title = list(text = "<b>Seasonal Difference (Winter - Summer) PM2.5</b>", font = list(size = 15)),
    xaxis = list(title = "Borough", titlefont = list(size = 12)),
    yaxis = list(title = "Year", titlefont = list(size = 12)),
    margin = list(l = 60, r = 80, t = 60, b = 60)
  )
```

---

# Key Findings & Conclusions

## Major Findings

<div class="row">
<div class="col-md-3">
<div class="stat-box">
<div class="stat-label">Air Quality Improvement</div>
<div class="stat-value">-42%</div>
<div class="stat-label">Average PM2.5 reduction since 2009</div>
</div>
</div>

<div class="col-md-3">
<div class="stat-box">
<div class="stat-label">Health Disparity</div>
<div class="stat-value">2-4x</div>
<div class="stat-label">Higher asthma rates in the Bronx</div>
</div>
</div>

<div class="col-md-3">
<div class="stat-box">
<div class="stat-label">Strongest Correlation</div>
<div class="stat-value">r > 0.7</div>
<div class="stat-label">PM2.5 and asthma association</div>
</div>
</div>

<div class="col-md-3">
<div class="stat-box">
<div class="stat-label">Seasonal Pattern</div>
<div class="stat-value">Shifting</div>
<div class="stat-label">Historical winter peak declining</div>
</div>
</div>
</div>

## Conclusions

1. **Air Quality Progress**: All five NYC boroughs demonstrated substantial reductions in PM2.5 concentrations between 2009 and 2023, with Manhattan showing the most dramatic improvement.

2. **Persistent Health Disparities**: Despite overall improvements, the Bronx continues to experience asthma ED visit rates 2-4 times higher than other boroughs, indicating environmental health inequities requiring targeted intervention.

3. **Strong PM2.5-Asthma Correlation**: Positive associations between PM2.5 levels and asthma ED visits were observed across all boroughs, supporting the causal relationship between air pollution and respiratory health outcomes.

4. **Changing Seasonal Patterns**: Historical winter peaks in PM2.5 have diminished in recent years, with summer concentrations becoming relatively more prominent.

5. **Geographic Variations**: Significant borough-level differences in both PM2.5 concentrations and asthma rates suggest that local factors play important roles beyond citywide air quality trends.

## Public Health Implications

<div style="background: linear-gradient(to right, #f0f9ff, #e0f2fe); padding: 25px; border-radius: 12px; border-left: 5px solid #2563eb; margin: 25px 0;">

- **Targeted Interventions**: The Bronx requires focused public health interventions to address disproportionate asthma burdens
- **Continued Monitoring**: Despite improvements, PM2.5 levels still impact respiratory health outcomes
- **Policy Success**: Declining PM2.5 trends suggest that air quality policies have been effective
- **Environmental Justice**: Persistent disparities highlight the need for equitable environmental health policies

</div>

---

<div class="footer-box">

**Data Sources:**
- PM2.5 Data: NYC Open Data
- Asthma ED Data: NYC Department of Health and Mental Hygiene (DOHMH)

**Institution:** Columbia University Mailman School of Public Health | P8105 Data Science I

</div>
