---
title: "Exploratory Data Analysis"
subtitle: "Air Pollution and Asthma in NYC (2009-2023)"
output: 
  html_document:
    toc: true
    toc_float: 
      collapsed: false
      smooth_scroll: true
    toc_depth: 3
    theme: cosmo
    code_folding: hide
    df_print: paged
---

<style>
/* Main container - wider for better content display */
.main-container {
  max-width: 1400px;
  margin: auto;
  padding: 20px;
}

/* Section headers - improved visibility */
.section-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white !important;
  padding: 25px;
  border-radius: 12px;
  margin-top: 40px;
  margin-bottom: 25px;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.section-header h1, 
.section-header h2,
.section-header h3 {
  color: white !important;
  margin: 0;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}

/* Improved text contrast */
body {
  color: #2d3748;
  font-size: 16px;
  line-height: 1.6;
}

h1, h2, h3, h4, h5, h6 {
  color: #1a202c;
  font-weight: 600;
}

/* Key findings box - better visibility */
.key-finding {
  background: linear-gradient(to right, #eff6ff, #dbeafe);
  border-left: 5px solid #2563eb;
  padding: 18px;
  margin: 20px 0;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
}

.key-finding strong {
  color: #1e40af;
  font-weight: 700;
}

/* Stat boxes - improved layout */
.stat-box {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 25px;
  border-radius: 12px;
  text-align: center;
  margin: 15px 5px;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  transition: transform 0.2s;
}

.stat-box:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.stat-value {
  font-size: 2.8em;
  font-weight: bold;
  margin: 15px 0;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

.stat-label {
  font-size: 1.05em;
  opacity: 0.95;
  line-height: 1.4;
}

/* Analyst note - improved visibility */
.analyst-note {
  background: linear-gradient(to right, #fffbeb, #fef3c7);
  border-left: 5px solid #f59e0b;
  padding: 15px;
  margin: 15px 0;
  border-radius: 8px;
  font-style: italic;
  box-shadow: 0 2px 8px rgba(245, 158, 11, 0.1);
}

.analyst-note strong {
  color: #92400e;
  font-weight: 700;
}

/* Tab styling */
.tabset-pills > li > a {
  border-radius: 20px;
  padding: 10px 24px;
  margin: 5px;
  font-weight: 600;
  transition: all 0.3s;
}

.tabset-pills > li.active > a {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.tabset-pills > li > a:hover {
  background-color: #e0e7ff;
}

/* Plotly containers - prevent overflow */
.plotly {
  width: 100% !important;
  max-width: 100%;
}

.plotly .main-svg {
  max-width: 100%;
}

/* Table styling */
.dataTables_wrapper {
  margin: 20px 0;
}

table {
  width: 100%;
  border-collapse: collapse;
}

/* Responsive images and plots */
img, 
.plotly,
.html-widget {
  max-width: 100%;
  height: auto;
}

/* Grid layout for stat boxes */
.row {
  display: flex;
  flex-wrap: wrap;
  margin: -10px;
}

.col-md-3 {
  flex: 0 0 25%;
  max-width: 25%;
  padding: 10px;
}

@media (max-width: 992px) {
  .col-md-3 {
    flex: 0 0 50%;
    max-width: 50%;
  }
}

@media (max-width: 576px) {
  .col-md-3 {
    flex: 0 0 100%;
    max-width: 100%;
  }
}

/* Code folding button */
.code-folding-btn {
  margin: 10px 0;
}

/* TOC styling - improved floating with sticky position */
#TOC {
  background-color: #f8fafc;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 15px;
  position: sticky !important;
  top: 20px !important;
  max-height: calc(100vh - 40px);
  overflow-y: auto;
}

/* Smooth TOC scrolling */
.tocify {
  border: none;
  border-radius: 8px;
}

.tocify-header {
  text-indent: 10px;
  font-size: 13px;
}

.tocify-subheader {
  font-size: 12px;
}

/* Footer styling */
.footer-box {
  background-color: #f8fafc;
  border: 1px solid #e2e8f0;
  padding: 25px;
  border-radius: 12px;
  margin-top: 40px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 12,
  fig.height = 4.5,
  out.width = "100%",
  dpi = 300
)

# Load all required libraries
library(tidyverse)
library(plotly)
library(viridis)
library(ggthemes)
library(scales)
library(patchwork)
library(knitr)
library(DT)
```

```{r load-data, include=FALSE}
# Load the merged dataset
pm25_asthma <- read_csv("data/merged_pm25_asthma.csv")

# Prepare data
pm25_asthma_clean <- pm25_asthma %>%
  mutate(
    borough = factor(borough, 
                     levels = c("Manhattan", "Bronx", "Brooklyn", 
                                "Queens", "Staten Island"))
  ) %>%
  arrange(year, borough)

# Long format for seasonal data
df_long <- pm25_asthma_clean %>%
  pivot_longer(
    cols = c(pm25_annual, pm25_summer, pm25_winter),
    names_to = "pm25_type",
    values_to = "pm25_value"
  ) %>%
  mutate(
    pm25_type = case_when(
      pm25_type == "pm25_annual" ~ "Annual",
      pm25_type == "pm25_summer" ~ "Summer",
      pm25_type == "pm25_winter" ~ "Winter"
    ),
    pm25_type = factor(pm25_type, levels = c("Annual", "Summer", "Winter"))
  )

# Calculate difference
pm25_asthma_clean <- pm25_asthma_clean %>%
  mutate(pm25_diff = pm25_winter - pm25_summer)
```

---

<div class="section-header">
<h1>üìä Overview</h1>
</div>

This comprehensive exploratory data analysis examines the relationship between air pollution (PM2.5) and asthma emergency department visits across NYC's five boroughs from 2009 to 2023. Our analysis combines time-series trends, seasonal patterns, geographic comparisons, and correlation analyses to understand how air quality affects respiratory health in different neighborhoods.

## Dataset Summary

```{r data-summary}
# Create summary table
summary_table <- tibble(
  Metric = c("Time Period", "Boroughs", "Total Observations", 
             "PM2.5 Range (Œºg/m¬≥)", "Asthma Rate Range (per 10,000)"),
  Value = c(
    "2009-2023 (14 years)",
    "Manhattan, Bronx, Brooklyn, Queens, Staten Island",
    nrow(pm25_asthma_clean),
    sprintf("%.1f - %.1f", min(pm25_asthma_clean$pm25_annual, na.rm = TRUE), 
            max(pm25_asthma_clean$pm25_annual, na.rm = TRUE)),
    sprintf("%.1f - %.1f", min(pm25_asthma_clean$asthma_rate, na.rm = TRUE), 
            max(pm25_asthma_clean$asthma_rate, na.rm = TRUE))
  )
)

kable(summary_table, col.names = c("", ""), align = c("l", "l"))
```

## Key Statistics by Borough

```{r borough-stats}
borough_summary <- pm25_asthma_clean %>%
  group_by(borough) %>%
  summarise(
    `Mean PM2.5` = round(mean(pm25_annual, na.rm = TRUE), 1),
    `Mean Asthma Rate` = round(mean(asthma_rate, na.rm = TRUE), 1),
    `2023 PM2.5` = round(pm25_annual[year == 2023], 1),
    `2023 Asthma` = round(asthma_rate[year == 2023], 1),
    `PM2.5 Change` = round(pm25_annual[year == 2023] - pm25_annual[year == 2009], 1),
    `Asthma Change` = round(asthma_rate[year == 2023] - asthma_rate[year == 2009], 1)
  ) %>%
  arrange(desc(`Mean Asthma Rate`))

datatable(borough_summary, 
          options = list(pageLength = 5, dom = 't'),
          rownames = FALSE) %>%
  formatStyle('Mean Asthma Rate',
              background = styleColorBar(borough_summary$`Mean Asthma Rate`, '#fecaca'),
              backgroundSize = '100% 90%',
              backgroundRepeat = 'no-repeat',
              backgroundPosition = 'center')
```

---

<div class="section-header">
<h1>üìà Time Series Analysis</h1>
</div>

## PM2.5 Trends Over Time

```{r pm25-timeseries-interactive}
p1 <- pm25_asthma_clean %>%
  plot_ly(x = ~year, y = ~pm25_annual, color = ~borough,
          type = 'scatter', mode = 'lines+markers',
          colors = viridis(5),
          hovertemplate = paste(
            '<b>%{fullData.name}</b><br>',
            'Year: %{x}<br>',
            'PM2.5: %{y:.2f} Œºg/m¬≥<br>',
            '<extra></extra>'
          )) %>%
  layout(
    title = list(
      text = "<b>Annual PM2.5 Concentrations by Borough (2009-2023)</b>",
      font = list(size = 18)
    ),
    xaxis = list(
      title = "Year",
      titlefont = list(size = 14),
      tickfont = list(size = 12),
      gridcolor = 'rgba(200,200,200,0.3)'
    ),
    yaxis = list(
      title = "PM2.5 (Œºg/m¬≥)",
      titlefont = list(size = 14),
      tickfont = list(size = 12),
      gridcolor = 'rgba(200,200,200,0.3)'
    ),
    hovermode = 'closest',
    legend = list(
      title = list(text = '<b>Borough</b>'),
      orientation = 'v',
      x = 1.02,
      y = 1,
      font = list(size = 11)
    ),
    plot_bgcolor = 'rgba(250,250,250,0.9)',
    paper_bgcolor = 'white',
    margin = list(l = 80, r = 120, t = 80, b = 60),
    autosize = TRUE
  )

p1
```

<div class="key-finding">
**Key Finding:** All five boroughs show consistent downward trends in PM2.5 concentrations, with Manhattan experiencing the steepest decline from 12.6 to 7.3 Œºg/m¬≥ (42% reduction).
</div>

## Asthma ED Visit Trends

```{r asthma-timeseries-interactive}
p2 <- pm25_asthma_clean %>%
  plot_ly(x = ~year, y = ~asthma_rate, color = ~borough,
          type = 'scatter', mode = 'lines+markers',
          colors = viridis(5, option = "plasma"),
          hovertemplate = paste(
            '<b>%{fullData.name}</b><br>',
            'Year: %{x}<br>',
            'ED Visit Rate: %{y:.1f} per 10,000<br>',
            '<extra></extra>'
          )) %>%
  layout(
    title = list(
      text = "<b>Asthma Emergency Department Visit Rates by Borough (2009-2023)</b>",
      font = list(size = 18)
    ),
    xaxis = list(
      title = "Year",
      titlefont = list(size = 14),
      tickfont = list(size = 12),
      gridcolor = 'rgba(200,200,200,0.3)'
    ),
    yaxis = list(
      title = "ED Visit Rate (per 10,000 population)",
      titlefont = list(size = 14),
      tickfont = list(size = 12),
      gridcolor = 'rgba(200,200,200,0.3)'
    ),
    hovermode = 'closest',
    legend = list(
      title = list(text = '<b>Borough</b>'),
      orientation = 'v',
      x = 1.02,
      y = 1,
      font = list(size = 11)
    ),
    plot_bgcolor = 'rgba(250,250,250,0.9)',
    paper_bgcolor = 'white',
    margin = list(l = 80, r = 120, t = 80, b = 60),
    autosize = TRUE
  )

p2
```

<div class="key-finding">
**Key Finding:** The Bronx consistently shows asthma ED rates 2-4 times higher than other boroughs throughout the study period, highlighting persistent health disparities.
</div>

## Combined View {.tabset .tabset-pills}

### Stacked View

```{r combined-interactive, fig.height=6}
combined_plot <- subplot(
  p1 %>% layout(showlegend = TRUE),
  p2 %>% layout(showlegend = FALSE),
  nrows = 2,
  shareX = FALSE,
  titleY = TRUE,
  heights = c(0.5, 0.5)
) %>%
  layout(
    title = list(
      text = "<b>PM2.5 and Asthma Trends Comparison</b>",
      font = list(size = 20)
    ),
    margin = list(t = 100)
  )

combined_plot
```

### Borough Tabs

```{r borough-tabs-setup, include=FALSE}
# Prepare data for individual borough analysis
borough_list <- levels(pm25_asthma_clean$borough)
```

#### Manhattan

```{r manhattan-dual}
manhattan_data <- pm25_asthma_clean %>% filter(borough == "Manhattan")

plot_ly(manhattan_data) %>%
  add_trace(
    x = ~year, y = ~pm25_annual,
    type = 'scatter', mode = 'lines+markers',
    name = 'PM2.5',
    yaxis = 'y',
    line = list(color = '#f59e0b', width = 3),
    marker = list(size = 8, color = '#f59e0b')
  ) %>%
  add_trace(
    x = ~year, y = ~asthma_rate,
    type = 'scatter', mode = 'lines+markers',
    name = 'Asthma Rate',
    yaxis = 'y2',
    line = list(color = '#dc2626', width = 3),
    marker = list(size = 8, color = '#dc2626')
  ) %>%
  layout(
    title = list(text = "<b>Manhattan: PM2.5 vs Asthma ED Visits</b>", font = list(size = 18)),
    xaxis = list(title = "Year", titlefont = list(size = 14)),
    yaxis = list(
      title = "PM2.5 (Œºg/m¬≥)",
      titlefont = list(size = 14, color = '#f59e0b'),
      tickfont = list(color = '#f59e0b')
    ),
    yaxis2 = list(
      title = "Asthma Rate (per 10,000)",
      titlefont = list(size = 14, color = '#dc2626'),
      tickfont = list(color = '#dc2626'),
      overlaying = 'y',
      side = 'right'
    ),
    margin = list(l = 80, r = 80, t = 80, b = 60),
    hovermode = 'x unified'
  )
```

#### Bronx

```{r bronx-dual}
bronx_data <- pm25_asthma_clean %>% filter(borough == "Bronx")

plot_ly(bronx_data) %>%
  add_trace(
    x = ~year, y = ~pm25_annual,
    type = 'scatter', mode = 'lines+markers',
    name = 'PM2.5',
    yaxis = 'y',
    line = list(color = '#f59e0b', width = 3),
    marker = list(size = 8, color = '#f59e0b')
  ) %>%
  add_trace(
    x = ~year, y = ~asthma_rate,
    type = 'scatter', mode = 'lines+markers',
    name = 'Asthma Rate',
    yaxis = 'y2',
    line = list(color = '#dc2626', width = 3),
    marker = list(size = 8, color = '#dc2626')
  ) %>%
  layout(
    title = list(text = "<b>Bronx: PM2.5 vs Asthma ED Visits</b>", font = list(size = 18)),
    xaxis = list(title = "Year", titlefont = list(size = 14)),
    yaxis = list(
      title = "PM2.5 (Œºg/m¬≥)",
      titlefont = list(size = 14, color = '#f59e0b'),
      tickfont = list(color = '#f59e0b')
    ),
    yaxis2 = list(
      title = "Asthma Rate (per 10,000)",
      titlefont = list(size = 14, color = '#dc2626'),
      tickfont = list(color = '#dc2626'),
      overlaying = 'y',
      side = 'right'
    ),
    margin = list(l = 80, r = 80, t = 80, b = 60),
    hovermode = 'x unified'
  )
```

#### Brooklyn

```{r brooklyn-dual}
brooklyn_data <- pm25_asthma_clean %>% filter(borough == "Brooklyn")

plot_ly(brooklyn_data) %>%
  add_trace(
    x = ~year, y = ~pm25_annual,
    type = 'scatter', mode = 'lines+markers',
    name = 'PM2.5',
    yaxis = 'y',
    line = list(color = '#f59e0b', width = 3),
    marker = list(size = 8, color = '#f59e0b')
  ) %>%
  add_trace(
    x = ~year, y = ~asthma_rate,
    type = 'scatter', mode = 'lines+markers',
    name = 'Asthma Rate',
    yaxis = 'y2',
    line = list(color = '#dc2626', width = 3),
    marker = list(size = 8, color = '#dc2626')
  ) %>%
  layout(
    title = list(text = "<b>Brooklyn: PM2.5 vs Asthma ED Visits</b>", font = list(size = 18)),
    xaxis = list(title = "Year", titlefont = list(size = 14)),
    yaxis = list(
      title = "PM2.5 (Œºg/m¬≥)",
      titlefont = list(size = 14, color = '#f59e0b'),
      tickfont = list(color = '#f59e0b')
    ),
    yaxis2 = list(
      title = "Asthma Rate (per 10,000)",
      titlefont = list(size = 14, color = '#dc2626'),
      tickfont = list(color = '#dc2626'),
      overlaying = 'y',
      side = 'right'
    ),
    margin = list(l = 80, r = 80, t = 80, b = 60),
    hovermode = 'x unified'
  )
```

#### Queens

```{r queens-dual}
queens_data <- pm25_asthma_clean %>% filter(borough == "Queens")

plot_ly(queens_data) %>%
  add_trace(
    x = ~year, y = ~pm25_annual,
    type = 'scatter', mode = 'lines+markers',
    name = 'PM2.5',
    yaxis = 'y',
    line = list(color = '#f59e0b', width = 3),
    marker = list(size = 8, color = '#f59e0b')
  ) %>%
  add_trace(
    x = ~year, y = ~asthma_rate,
    type = 'scatter', mode = 'lines+markers',
    name = 'Asthma Rate',
    yaxis = 'y2',
    line = list(color = '#dc2626', width = 3),
    marker = list(size = 8, color = '#dc2626')
  ) %>%
  layout(
    title = list(text = "<b>Queens: PM2.5 vs Asthma ED Visits</b>", font = list(size = 18)),
    xaxis = list(title = "Year", titlefont = list(size = 14)),
    yaxis = list(
      title = "PM2.5 (Œºg/m¬≥)",
      titlefont = list(size = 14, color = '#f59e0b'),
      tickfont = list(color = '#f59e0b')
    ),
    yaxis2 = list(
      title = "Asthma Rate (per 10,000)",
      titlefont = list(size = 14, color = '#dc2626'),
      tickfont = list(color = '#dc2626'),
      overlaying = 'y',
      side = 'right'
    ),
    margin = list(l = 80, r = 80, t = 80, b = 60),
    hovermode = 'x unified'
  )
```

#### Staten Island

```{r staten-island-dual}
staten_data <- pm25_asthma_clean %>% filter(borough == "Staten Island")

plot_ly(staten_data) %>%
  add_trace(
    x = ~year, y = ~pm25_annual,
    type = 'scatter', mode = 'lines+markers',
    name = 'PM2.5',
    yaxis = 'y',
    line = list(color = '#f59e0b', width = 3),
    marker = list(size = 8, color = '#f59e0b')
  ) %>%
  add_trace(
    x = ~year, y = ~asthma_rate,
    type = 'scatter', mode = 'lines+markers',
    name = 'Asthma Rate',
    yaxis = 'y2',
    line = list(color = '#dc2626', width = 3),
    marker = list(size = 8, color = '#dc2626')
  ) %>%
  layout(
    title = list(text = "<b>Staten Island: PM2.5 vs Asthma ED Visits</b>", font = list(size = 18)),
    xaxis = list(title = "Year", titlefont = list(size = 14)),
    yaxis = list(
      title = "PM2.5 (Œºg/m¬≥)",
      titlefont = list(size = 14, color = '#f59e0b'),
      tickfont = list(color = '#f59e0b')
    ),
    yaxis2 = list(
      title = "Asthma Rate (per 10,000)",
      titlefont = list(size = 14, color = '#dc2626'),
      tickfont = list(color = '#dc2626'),
      overlaying = 'y',
      side = 'right'
    ),
    margin = list(l = 80, r = 80, t = 80, b = 60),
    hovermode = 'x unified'
  )
```

---

<div class="section-header">
<h1>üîó Association Analysis</h1>
</div>

## PM2.5 vs Asthma Rate Correlation

```{r correlation-scatter}
# Calculate correlation by borough
cor_by_borough <- pm25_asthma_clean %>%
  group_by(borough) %>%
  summarise(
    correlation = cor(pm25_annual, asthma_rate, use = "complete.obs"),
    .groups = 'drop'
  ) %>%
  arrange(desc(correlation))

# Create scatter plot
plot_ly(pm25_asthma_clean, x = ~pm25_annual, y = ~asthma_rate, 
        color = ~borough, colors = viridis(5),
        type = 'scatter', mode = 'markers',
        marker = list(size = 10, opacity = 0.7),
        text = ~paste('Year:', year, '<br>Borough:', borough,
                     '<br>PM2.5:', round(pm25_annual, 1),
                     '<br>Asthma Rate:', round(asthma_rate, 1)),
        hoverinfo = 'text') %>%
  layout(
    title = list(
      text = "<b>PM2.5 vs Asthma ED Visit Rates</b>",
      font = list(size = 18)
    ),
    xaxis = list(
      title = "PM2.5 (Œºg/m¬≥)",
      titlefont = list(size = 14),
      tickfont = list(size = 12)
    ),
    yaxis = list(
      title = "Asthma ED Visit Rate (per 10,000)",
      titlefont = list(size = 14),
      tickfont = list(size = 12)
    ),
    legend = list(
      title = list(text = '<b>Borough</b>'),
      font = list(size = 11)
    ),
    margin = list(l = 80, r = 100, t = 80, b = 60),
    autosize = TRUE
  )
```

### Correlation Summary Table

```{r correlation-table}
cor_table <- pm25_asthma_clean %>%
  group_by(borough) %>%
  summarise(
    `Correlation (r)` = round(cor(pm25_annual, asthma_rate, use = "complete.obs"), 3),
    `Mean PM2.5` = round(mean(pm25_annual, na.rm = TRUE), 1),
    `Mean Asthma Rate` = round(mean(asthma_rate, na.rm = TRUE), 1),
    .groups = 'drop'
  ) %>%
  arrange(desc(`Correlation (r)`))

datatable(cor_table, 
          options = list(pageLength = 5, dom = 't'),
          rownames = FALSE) %>%
  formatStyle('Correlation (r)',
              background = styleColorBar(cor_table$`Correlation (r)`, '#dbeafe'),
              backgroundSize = '100% 90%',
              backgroundRepeat = 'no-repeat',
              backgroundPosition = 'center')
```

<div class="key-finding">
**Key Finding:** Strong positive correlations (r > 0.7) between PM2.5 and asthma rates across all boroughs, with Brooklyn showing the strongest association (r = 0.82).
</div>

---

<div class="section-header">
<h1>üó∫Ô∏è Borough Comparison</h1>
</div>

## Borough-Level Trends {.tabset .tabset-pills}

### PM2.5 Trends

```{r borough-pm25-facet, fig.height=6, fig.width=12}
ggplot(pm25_asthma_clean, aes(x = year, y = pm25_annual, color = borough)) +
  geom_line(size = 1.2) +
  geom_point(size = 2.5) +
  facet_wrap(~ borough, ncol = 2, scales = "free_y") +
  scale_color_viridis_d() +
  labs(
    title = "PM2.5 Concentration Trends by Borough (2009-2023)",
    x = "Year",
    y = "PM2.5 (Œºg/m¬≥)",
    color = "Borough"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    strip.text = element_text(face = "bold", size = 12),
    strip.background = element_rect(fill = "gray90", color = NA),
    legend.position = "none",
    panel.grid.minor = element_blank()
  )
```

### Asthma Trends

```{r borough-asthma-facet, fig.height=6, fig.width=12}
ggplot(pm25_asthma_clean, aes(x = year, y = asthma_rate, color = borough)) +
  geom_line(size = 1.2) +
  geom_point(size = 2.5) +
  facet_wrap(~ borough, ncol = 2, scales = "free_y") +
  scale_color_viridis_d(option = "plasma") +
  labs(
    title = "Asthma ED Visit Rate Trends by Borough (2009-2023)",
    x = "Year",
    y = "Asthma ED Visit Rate (per 10,000)",
    color = "Borough"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    strip.text = element_text(face = "bold", size = 12),
    strip.background = element_rect(fill = "gray90", color = NA),
    legend.position = "none",
    panel.grid.minor = element_blank()
  )
```

### Association by Borough

```{r borough-scatter-facet, fig.height=6, fig.width=12}
ggplot(pm25_asthma_clean, aes(x = pm25_annual, y = asthma_rate)) +
  geom_point(aes(color = borough), size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", se = TRUE, color = "#2563eb", size = 1) +
  facet_wrap(~ borough, ncol = 2, scales = "free") +
  scale_color_viridis_d() +
  labs(
    title = "PM2.5 vs Asthma Rate Relationship by Borough",
    x = "PM2.5 (Œºg/m¬≥)",
    y = "Asthma ED Visit Rate (per 10,000)",
    color = "Borough"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    strip.text = element_text(face = "bold", size = 12),
    strip.background = element_rect(fill = "gray90", color = NA),
    legend.position = "none",
    panel.grid.minor = element_blank()
  )
```

### Side-by-Side Comparison

```{r borough-comparison, fig.height=5.5, fig.width=14}
# 2023 comparison
data_2023 <- pm25_asthma_clean %>% filter(year == 2023)

p_pm25 <- ggplot(data_2023, aes(x = reorder(borough, -pm25_annual), y = pm25_annual, fill = borough)) +
  geom_col(alpha = 0.8) +
  geom_text(aes(label = round(pm25_annual, 1)), vjust = -0.5, size = 5, fontface = "bold") +
  scale_fill_viridis_d() +
  labs(
    title = "PM2.5 Levels (2023)",
    x = NULL,
    y = "PM2.5 (Œºg/m¬≥)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  ylim(0, max(data_2023$pm25_annual) * 1.15)

p_asthma <- ggplot(data_2023, aes(x = reorder(borough, -asthma_rate), y = asthma_rate, fill = borough)) +
  geom_col(alpha = 0.8) +
  geom_text(aes(label = round(asthma_rate, 1)), vjust = -0.5, size = 5, fontface = "bold") +
  scale_fill_viridis_d(option = "plasma") +
  labs(
    title = "Asthma ED Rates (2023)",
    x = NULL,
    y = "Asthma Rate (per 10,000)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  ylim(0, max(data_2023$asthma_rate) * 1.15)

p_pm25 + p_asthma
```

---

<div class="section-header">
<h1>üå°Ô∏è Seasonal Patterns</h1>
</div>

## Summer vs Winter Patterns

```{r seasonal-boxplot, fig.height=4.5, fig.width=12}
seasonal_long <- pm25_asthma_clean %>%
  select(borough, year, pm25_summer, pm25_winter) %>%
  pivot_longer(
    cols = c(pm25_summer, pm25_winter),
    names_to = "season",
    values_to = "pm25"
  ) %>%
  mutate(
    season = ifelse(season == "pm25_summer", "Summer", "Winter")
  )

ggplot(seasonal_long, aes(x = borough, y = pm25, fill = season)) +
  geom_boxplot(alpha = 0.8, outlier.shape = 21, outlier.size = 2) +
  scale_fill_manual(values = c("Summer" = "#fbbf24", "Winter" = "#60a5fa")) +
  labs(
    title = "Seasonal PM2.5 Distribution by Borough (2009-2023)",
    x = "Borough",
    y = "PM2.5 (Œºg/m¬≥)",
    fill = "Season"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    legend.position = "top",
    legend.title = element_text(face = "bold", size = 13),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 12),
    panel.grid.minor = element_blank()
  )
```

## Seasonal Trends Over Time

```{r seasonal-trends, fig.height=6, fig.width=13}
ggplot(df_long, aes(x = year, y = pm25_value, color = pm25_type, group = pm25_type)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  facet_wrap(~ borough, ncol = 2, scales = "free_y") +
  scale_color_manual(
    values = c("Annual" = "#667eea", "Summer" = "#fbbf24", "Winter" = "#60a5fa")
  ) +
  labs(
    title = "Seasonal PM2.5 Trends by Borough (2009-2023)",
    x = "Year",
    y = "PM2.5 (Œºg/m¬≥)",
    color = "Measurement"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5),
    strip.text = element_text(face = "bold", size = 12),
    strip.background = element_rect(fill = "gray90", color = NA),
    legend.position = "top",
    legend.title = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )
```

<div class="key-finding">
**Key Finding:** Historical winter peaks in PM2.5 have diminished over time, with summer and winter levels now converging in most boroughs.
</div>

---

<div class="section-header">
<h1>üî• Heatmap Analysis</h1>
</div>

## Interactive Heatmaps {.tabset .tabset-pills}

### Annual PM2.5

```{r heatmap-pm25-annual}
heatmap_data_pm25 <- pm25_asthma_clean %>%
  select(year, borough, pm25_annual) %>%
  pivot_wider(names_from = borough, values_from = pm25_annual) %>%
  column_to_rownames("year")

plot_ly(
  x = colnames(heatmap_data_pm25),
  y = rownames(heatmap_data_pm25),
  z = as.matrix(heatmap_data_pm25),
  type = "heatmap",
  colors = colorRamp(c("#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c", "#fc4e2a", "#e31a1c", "#bd0026", "#800026")),
  hovertemplate = 'Borough: %{x}<br>Year: %{y}<br>PM2.5: %{z:.1f} Œºg/m¬≥<extra></extra>'
) %>%
  layout(
    title = list(
      text = "<b>Annual PM2.5 Concentrations (2009-2023)</b>",
      font = list(size = 18)
    ),
    xaxis = list(title = "Borough", titlefont = list(size = 14)),
    yaxis = list(title = "Year", titlefont = list(size = 14)),
    margin = list(l = 80, r = 100, t = 80, b = 80)
  )
```

### Asthma Rate

```{r heatmap-asthma}
heatmap_data_asthma <- pm25_asthma_clean %>%
  select(year, borough, asthma_rate) %>%
  pivot_wider(names_from = borough, values_from = asthma_rate) %>%
  column_to_rownames("year")

plot_ly(
  x = colnames(heatmap_data_asthma),
  y = rownames(heatmap_data_asthma),
  z = as.matrix(heatmap_data_asthma),
  type = "heatmap",
  colors = colorRamp(c("#fff5f0", "#fee0d2", "#fcbba1", "#fc9272", "#fb6a4a", "#ef3b2c", "#cb181d", "#a50f15", "#67000d")),
  hovertemplate = 'Borough: %{x}<br>Year: %{y}<br>Asthma Rate: %{z:.1f} per 10,000<extra></extra>'
) %>%
  layout(
    title = list(
      text = "<b>Asthma ED Visit Rates (2009-2023)</b>",
      font = list(size = 18)
    ),
    xaxis = list(title = "Borough", titlefont = list(size = 14)),
    yaxis = list(title = "Year", titlefont = list(size = 14)),
    margin = list(l = 80, r = 100, t = 80, b = 80)
  )
```

### Summer PM2.5

```{r heatmap-summer}
heatmap_data_summer <- pm25_asthma_clean %>%
  select(year, borough, pm25_summer) %>%
  pivot_wider(names_from = borough, values_from = pm25_summer) %>%
  column_to_rownames("year")

plot_ly(
  x = colnames(heatmap_data_summer),
  y = rownames(heatmap_data_summer),
  z = as.matrix(heatmap_data_summer),
  type = "heatmap",
  colors = colorRamp(c("#ffffcc", "#ffeda0", "#fed976", "#feb24c", "#fd8d3c")),
  hovertemplate = 'Borough: %{x}<br>Year: %{y}<br>Summer PM2.5: %{z:.1f} Œºg/m¬≥<extra></extra>'
) %>%
  layout(
    title = list(
      text = "<b>Summer PM2.5 Concentrations (2009-2023)</b>",
      font = list(size = 18)
    ),
    xaxis = list(title = "Borough", titlefont = list(size = 14)),
    yaxis = list(title = "Year", titlefont = list(size = 14)),
    margin = list(l = 80, r = 100, t = 80, b = 80)
  )
```

### Winter PM2.5

```{r heatmap-winter}
heatmap_data_winter <- pm25_asthma_clean %>%
  select(year, borough, pm25_winter) %>%
  pivot_wider(names_from = borough, values_from = pm25_winter) %>%
  column_to_rownames("year")

plot_ly(
  x = colnames(heatmap_data_winter),
  y = rownames(heatmap_data_winter),
  z = as.matrix(heatmap_data_winter),
  type = "heatmap",
  colors = colorRamp(c("#f7fbff", "#deebf7", "#c6dbef", "#9ecae1", "#6baed6", "#4292c6", "#2171b5", "#08519c", "#08306b")),
  hovertemplate = 'Borough: %{x}<br>Year: %{y}<br>Winter PM2.5: %{z:.1f} Œºg/m¬≥<extra></extra>'
) %>%
  layout(
    title = list(
      text = "<b>Winter PM2.5 Concentrations (2009-2023)</b>",
      font = list(size = 18)
    ),
    xaxis = list(title = "Borough", titlefont = list(size = 14)),
    yaxis = list(title = "Year", titlefont = list(size = 14)),
    margin = list(l = 80, r = 100, t = 80, b = 80)
  )
```

### Seasonal Difference

```{r heatmap-difference}
heatmap_data_diff <- pm25_asthma_clean %>%
  select(year, borough, pm25_diff) %>%
  pivot_wider(names_from = borough, values_from = pm25_diff) %>%
  column_to_rownames("year")

plot_ly(
  x = colnames(heatmap_data_diff),
  y = rownames(heatmap_data_diff),
  z = as.matrix(heatmap_data_diff),
  type = "heatmap",
  colors = colorRamp(c("#0571b0", "#92c5de", "#f7f7f7", "#f4a582", "#ca0020")),
  hovertemplate = 'Borough: %{x}<br>Year: %{y}<br>Difference: %{z:.1f} Œºg/m¬≥<extra></extra>'
) %>%
  layout(
    title = list(
      text = "<b>Seasonal Difference (Winter - Summer) PM2.5</b>",
      font = list(size = 18)
    ),
    xaxis = list(title = "Borough", titlefont = list(size = 14)),
    yaxis = list(title = "Year", titlefont = list(size = 14)),
    margin = list(l = 80, r = 100, t = 80, b = 80)
  )
```

---

<div class="section-header">
<h1>üìä Key Findings & Conclusions</h1>
</div>

## Major Findings

<div class="row">
<div class="col-md-3">
<div class="stat-box">
<div class="stat-label">Air Quality Improvement</div>
<div class="stat-value">-42%</div>
<div class="stat-label">Average PM2.5 reduction since 2009</div>
</div>
</div>

<div class="col-md-3">
<div class="stat-box">
<div class="stat-label">Health Disparity</div>
<div class="stat-value">2-4x</div>
<div class="stat-label">Higher asthma rates in the Bronx</div>
</div>
</div>

<div class="col-md-3">
<div class="stat-box">
<div class="stat-label">Strongest Correlation</div>
<div class="stat-value">r > 0.7</div>
<div class="stat-label">PM2.5 and asthma association</div>
</div>
</div>

<div class="col-md-3">
<div class="stat-box">
<div class="stat-label">Seasonal Pattern</div>
<div class="stat-value">Shifting</div>
<div class="stat-label">Historical winter peak declining</div>
</div>
</div>
</div>

## Conclusions

1. **Air Quality Progress**: All five NYC boroughs demonstrated substantial reductions in PM2.5 concentrations between 2009 and 2023, with Manhattan showing the most dramatic improvement (5.3 Œºg/m¬≥ decrease).

2. **Persistent Health Disparities**: Despite overall improvements, the Bronx continues to experience asthma ED visit rates 2-4 times higher than other boroughs, indicating environmental health inequities requiring targeted intervention.

3. **Strong PM2.5-Asthma Correlation**: Positive associations between PM2.5 levels and asthma ED visits were observed across all boroughs, supporting the causal relationship between air pollution and respiratory health outcomes.

4. **Changing Seasonal Patterns**: Historical winter peaks in PM2.5 have diminished in recent years, with summer concentrations becoming relatively more prominent, potentially due to changing weather patterns or emission sources.

5. **Geographic Variations**: Significant borough-level differences in both PM2.5 concentrations and asthma rates suggest that local factors (traffic density, industrial activity, green space) play important roles beyond citywide air quality trends.

## Public Health Implications

<div style="background: linear-gradient(to right, #f0f9ff, #e0f2fe); padding: 25px; border-radius: 12px; border-left: 5px solid #2563eb; margin: 25px 0;">

- **Targeted Interventions**: The Bronx requires focused public health interventions to address disproportionate asthma burdens
- **Continued Monitoring**: Despite improvements, PM2.5 levels still impact respiratory health outcomes
- **Policy Success**: Declining PM2.5 trends suggest that air quality policies have been effective
- **Environmental Justice**: Persistent disparities highlight the need for equitable environmental health policies

</div>

---

<div class="footer-box">

**üìä Data Sources:**
- PM2.5 Data: NYC Open Data
- Asthma ED Data: NYC Department of Health and Mental Hygiene (DOHMH)

**üèõÔ∏è Institution:** Columbia University Mailman School of Public Health | P8105 Data Science I

</div>
