---
title: "Spatial Modeling"
subtitle: "Geographic Analysis Using Official NYC Boundaries"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: cosmo
    code_folding: hide
---

<style>
.main-container {
  max-width: 1400px;
  margin: auto;
  padding: 20px;
}

body {
  color: #2d3748;
  font-size: 16px;
  line-height: 1.6;
}

h1:not(.title) {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white !important;
  padding: 20px 25px;
  border-radius: 12px;
  margin-top: 35px;
  margin-bottom: 20px;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
  font-weight: 600;
  font-size: 1.8em;
}

h1.title {
  color: #1a202c;
  font-weight: 700;
  margin-bottom: 10px;
}

h2, h3, h4, h5, h6 {
  color: #1a202c;
  font-weight: 600;
}

.spatial-insight {
  background: linear-gradient(to right, #f0f9ff, #e0f2fe);
  border-left: 5px solid #2563eb;
  padding: 18px;
  margin: 20px 0;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
}

.spatial-insight strong {
  color: #1e40af;
  font-weight: 700;
}

.map-section {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  overflow: hidden;
}

.warning-box {
  background: linear-gradient(to right, #fffbeb, #fef3c7);
  border-left: 5px solid #f59e0b;
  padding: 15px;
  margin: 15px 0;
  border-radius: 8px;
}

.tabset-pills > li > a {
  border-radius: 20px;
  padding: 10px 24px;
  margin: 5px;
  font-weight: 600;
  transition: all 0.3s;
}

.tabset-pills > li.active > a {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.tabset-pills > li > a:hover {
  background-color: #e0e7ff;
}

.leaflet-container {
  border-radius: 8px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 4.5
)

library(tidyverse)
library(sf)
library(leaflet)
library(leaflet.extras)
library(viridis)
library(plotly)
library(RColorBrewer)
library(DT)
library(tigris)
library(htmltools)
library(patchwork)
```

```{r load-data, include=FALSE}
pm25_asthma <- read_csv("data/merged_pm25_asthma.csv") %>%
  mutate(
    borough = factor(borough, 
                     levels = c("Manhattan", "Bronx", "Brooklyn", 
                                "Queens", "Staten Island"))
  )
```

---

# Data Preparation

## Download Census Boundaries

```{r download-shapefiles, message=FALSE, warning=FALSE, results='hide'}
options(tigris_use_cache = TRUE)

ny_counties <- counties(state = "NY", cb = TRUE, year = 2023)

nyc_county_names <- c("New York", "Kings", "Queens", "Bronx", "Richmond")

nyc_boroughs_tiger <- ny_counties %>%
  filter(NAME %in% nyc_county_names)

nyc_boroughs <- nyc_boroughs_tiger %>%
  mutate(
    borough = case_when(
      NAME == "New York" ~ "Manhattan",
      NAME == "Kings" ~ "Brooklyn",
      NAME == "Queens" ~ "Queens",
      NAME == "Bronx" ~ "Bronx",
      NAME == "Richmond" ~ "Staten Island"
    ),
    borough = factor(borough, 
                     levels = c("Manhattan", "Bronx", "Brooklyn", 
                                "Queens", "Staten Island"))
  ) %>%
  select(borough, NAME, geometry)
```

```{r shapefile-info}
st_crs(nyc_boroughs)

nyc_boroughs %>% 
  st_drop_geometry() %>%
  select(borough) %>%
  knitr::kable()
```

## Merge Spatial Data

```{r merge-data}
spatial_data_2023 <- pm25_asthma %>%
  filter(year == 2023) %>%
  right_join(nyc_boroughs, by = "borough") %>%
  st_as_sf()

spatial_data_full <- pm25_asthma %>%
  right_join(nyc_boroughs, by = "borough") %>%
  st_as_sf()

cat("Data merged successfully\n")
cat("Features:", nrow(spatial_data_2023), "\n")
```

---

# Interactive Choropleth Maps {.tabset .tabset-pills}

## PM2.5 (2023)

<div class="map-section">

```{r choropleth-pm25, fig.height=5}
pal_pm25 <- colorNumeric(
  palette = "YlOrRd",
  domain = spatial_data_2023$pm25_annual,
  na.color = "transparent"
)

leaflet(spatial_data_2023, width = "100%", height = "450px") %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    fillColor = ~pal_pm25(pm25_annual),
    weight = 2,
    opacity = 1,
    color = "white",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 3,
      color = "#666",
      fillOpacity = 0.85,
      bringToFront = TRUE
    ),
    label = ~paste0(
      borough, ": ",
      round(pm25_annual, 1), " μg/m³"
    ),
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "14px",
      direction = "auto"
    )
  ) %>%
  addLegend(
    pal = pal_pm25,
    values = ~pm25_annual,
    opacity = 0.7,
    title = "PM2.5 (μg/m³)",
    position = "bottomright"
  )
```

</div>

<div class="spatial-insight">
**Key Finding:** Manhattan shows the lowest PM2.5 levels (7.3 μg/m³) while Brooklyn has the highest (8.2 μg/m³) in 2023.
</div>

## Asthma (2023)

<div class="map-section">

```{r choropleth-asthma, fig.height=5}
pal_asthma <- colorNumeric(
  palette = "Reds",
  domain = spatial_data_2023$asthma_rate,
  na.color = "transparent"
)

leaflet(spatial_data_2023, width = "100%", height = "450px") %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    fillColor = ~pal_asthma(asthma_rate),
    weight = 2,
    opacity = 1,
    color = "white",
    fillOpacity = 0.7,
    highlightOptions = highlightOptions(
      weight = 3,
      color = "#666",
      fillOpacity = 0.85,
      bringToFront = TRUE
    ),
    label = ~paste0(
      borough, ": ",
      round(asthma_rate, 1), " per 10,000"
    ),
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "14px",
      direction = "auto"
    )
  ) %>%
  addLegend(
    pal = pal_asthma,
    values = ~asthma_rate,
    opacity = 0.7,
    title = "Asthma Rate<br>(per 10,000)",
    position = "bottomright"
  )
```

</div>

<div class="spatial-insight">
**Key Finding:** The Bronx has dramatically higher asthma ED rates (172.4 per 10,000) compared to other boroughs, highlighting severe health disparities.
</div>

## Side-by-Side

<div class="map-section">

```{r side-by-side, fig.height=6}
map_pm25 <- leaflet(spatial_data_2023, width = "100%", height = "550px") %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    fillColor = ~pal_pm25(pm25_annual),
    weight = 2,
    opacity = 1,
    color = "white",
    fillOpacity = 0.7,
    label = ~paste0(borough, ": ", round(pm25_annual, 1), " μg/m³")
  ) %>%
  addLegend(
    pal = pal_pm25,
    values = ~pm25_annual,
    opacity = 0.7,
    title = "PM2.5",
    position = "bottomright"
  )

map_asthma <- leaflet(spatial_data_2023, width = "100%", height = "550px") %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    fillColor = ~pal_asthma(asthma_rate),
    weight = 2,
    opacity = 1,
    color = "white",
    fillOpacity = 0.7,
    label = ~paste0(borough, ": ", round(asthma_rate, 1), " per 10,000")
  ) %>%
  addLegend(
    pal = pal_asthma,
    values = ~asthma_rate,
    opacity = 0.7,
    title = "Asthma",
    position = "bottomright"
  )

tagList(
  tags$div(style = "display: flex; justify-content: space-between; gap: 15px;",
    tags$div(style = "flex: 1;", map_pm25),
    tags$div(style = "flex: 1;", map_asthma)
  )
)
```

</div>

---

# Static Choropleth Maps

## 2023 Overview

```{r static-choropleth, fig.height=5, fig.width=12}
p1 <- ggplot(spatial_data_2023) +
  geom_sf(aes(fill = pm25_annual), color = "white", size = 0.8) +
  scale_fill_viridis_c(option = "plasma", name = "PM2.5\n(μg/m³)") +
  labs(title = "PM2.5 Concentrations (2023)") +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size = 14),
    legend.position = "right",
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )

p2 <- ggplot(spatial_data_2023) +
  geom_sf(aes(fill = asthma_rate), color = "white", size = 0.8) +
  scale_fill_viridis_c(option = "inferno", name = "Asthma Rate\n(per 10,000)") +
  labs(title = "Asthma ED Rates (2023)") +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size = 14),
    legend.position = "right",
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )

p1 + p2
```

---

# Temporal Patterns

## PM2.5 Over Time

```{r faceted-pm25, fig.height=8, fig.width=12}
years_selected <- c(2009, 2013, 2017, 2023)

spatial_data_selected <- spatial_data_full %>%
  filter(year %in% years_selected)

ggplot(spatial_data_selected) +
  geom_sf(aes(fill = pm25_annual), color = "white", size = 0.5) +
  scale_fill_viridis_c(option = "plasma", name = "PM2.5 (μg/m³)") +
  facet_wrap(~ year, ncol = 2) +
  labs(title = "PM2.5 Concentration Changes (2009-2023)") +
  theme_minimal(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size = 14),
    strip.text = element_text(face = "bold", size = 11),
    strip.background = element_rect(fill = "gray90", color = NA),
    legend.position = "bottom",
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )
```

<div class="spatial-insight">
**Temporal Finding:** All boroughs show consistent PM2.5 reductions from 2009 to 2023, with the spatial pattern remaining relatively stable across years.
</div>

## Asthma Over Time

```{r faceted-asthma, fig.height=8, fig.width=12}
ggplot(spatial_data_selected) +
  geom_sf(aes(fill = asthma_rate), color = "white", size = 0.5) +
  scale_fill_viridis_c(option = "inferno", name = "Asthma Rate\n(per 10,000)") +
  facet_wrap(~ year, ncol = 2) +
  labs(title = "Asthma ED Rate Changes (2009-2023)") +
  theme_minimal(base_size = 11) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size = 14),
    strip.text = element_text(face = "bold", size = 11),
    strip.background = element_rect(fill = "gray90", color = NA),
    legend.position = "bottom",
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )
```

<div class="spatial-insight">
**Temporal Finding:** The Bronx maintains persistently high asthma rates across all years, indicating long-standing environmental health challenges.
</div>

---

# Summary Statistics

## Borough Comparison Table

```{r summary-table}
summary_2023 <- spatial_data_2023 %>%
  st_drop_geometry() %>%
  select(borough, pm25_annual, asthma_rate) %>%
  arrange(desc(asthma_rate))

datatable(
  summary_2023,
  colnames = c("Borough", "PM2.5 (μg/m³)", "Asthma Rate (per 10,000)"),
  options = list(pageLength = 5, dom = 't'),
  rownames = FALSE
) %>%
  formatRound(c("pm25_annual", "asthma_rate"), 1)
```

## Key Insights

<div class="spatial-insight">

**Geographic Patterns:**

1. **PM2.5 Distribution:** Relatively uniform across boroughs (7.3-8.2 μg/m³), with Brooklyn slightly elevated.
2. **Asthma Disparities:** Stark contrast between the Bronx (172.4) and other boroughs (38.6-91.2).
3. **Environmental Justice:** The 2-4x higher asthma rates in the Bronx suggest complex interactions beyond PM2.5 alone.

</div>

---

<div style="background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 25px; border-radius: 12px; margin-top: 40px;">

**Data Sources:**
- Spatial Boundaries: U.S. Census Bureau TIGER/Line Shapefiles (2023)
- PM2.5 & Asthma Data: NYC Open Data & NYC DOHMH

**Institution:** Columbia University Mailman School of Public Health | P8105 Data Science I

</div>
